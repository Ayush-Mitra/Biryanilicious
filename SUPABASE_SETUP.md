# Supabase Setup Guide for Biryani Project

This guide will help you set up Supabase as the backend database for your Node.js project.

## 1. Create a Supabase Account and Project
1. Go to [https://supabase.com/](https://supabase.com/) and sign up or log in.
2. Click **New Project**.
3. Enter your project name, password, and select a region.
4. Click **Create new project**.

## 2. Get Your Supabase API Keys
- After project creation, go to **Project Settings > API**.
- Note your **Project URL** and **anon/public API key** (you'll need these for your Node.js backend).

## 3. Set Up Database Tables
Go to the **Table Editor** in Supabase and create the following tables, or use the SQL code provided below for a quick setup:

### 3.1. `menu`
| Column Name   | Type      | Notes                |
|--------------|-----------|----------------------|
| id           | int8      | Primary Key, auto-increment |
| name         | text      | Name of the dish     |
| description  | text      | Description          |
| price        | float8    | Price                |
| image_url    | text      | Image URL            |
| available    | boolean   | Is item available?   |

### 3.2. `services`
| Column Name   | Type      | Notes                |
|--------------|-----------|----------------------|
| id           | int8      | Primary Key, auto-increment |
| name         | text      | Service name         |
| description  | text      | Description          |
| active       | boolean   | Is service active?   |

### 3.3. `trending`
| Column Name   | Type      | Notes                |
|--------------|-----------|----------------------|
| id           | int8      | Primary Key, auto-increment |
| menu_id      | int8      | Foreign key to menu  |
| rank         | int4      | Trending rank/order  |

### 3.4. `orders`
| Column Name     | Type      | Notes                |
|----------------|-----------|----------------------|
| id             | int8      | Primary Key, auto-increment |
| user_name      | text      | Name of the user     |
| contact_number | text      | User's contact number|
| address        | text      | Delivery address     |
| restaurant     | text      | Restaurant name      |
| items          | jsonb     | List of items and quantities |
| payment_status | text      | e.g., 'pending', 'paid' |
| created_at     | timestamp | Order time           |

### 3.5. `admin_users`
| Column Name | Type    | Notes                        |
|------------|---------|------------------------------|
| id         | int8    | Primary Key, auto-increment   |
| username   | text    | Admin username                |
| password   | text    | Hashed password (store securely!) |

## 4. Quick Table Setup with SQL
You can use the following SQL code in the Supabase SQL editor to create all tables and relationships at once:

```sql
-- 1. Menu Table
CREATE TABLE public.menu (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    price DOUBLE PRECISION NOT NULL,
    image_url TEXT,
    available BOOLEAN DEFAULT TRUE
);

-- 2. Services Table
CREATE TABLE public.services (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    active BOOLEAN DEFAULT TRUE
);

-- 3. Trending Table
CREATE TABLE public.trending (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    menu_id BIGINT REFERENCES public.menu(id) ON DELETE CASCADE,
    rank INTEGER
);

-- 4. Orders Table
CREATE TABLE public.orders (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_name TEXT NOT NULL,
    contact_number TEXT,
    address TEXT,
    restaurant TEXT,
    items JSONB, -- [{menu_id: 1, quantity: 2}, ...]
    payment_status TEXT DEFAULT 'pending',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc', now())
);

-- 5. Admin Users Table
CREATE TABLE public.admin_users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username TEXT NOT NULL UNIQUE,
    password TEXT NOT NULL -- Store hashed passwords only!
);

-- Index for faster lookup on trending
CREATE INDEX trending_menu_id_idx ON public.trending(menu_id);
```

**How to use:**
1. Go to your Supabase project dashboard.
2. Click on **SQL Editor** in the sidebar.
3. Paste the above SQL code and click **Run**.
4. All tables and relationships will be created automatically.

## 5. Enable Row Level Security (RLS)
- Go to each table's settings and enable RLS for security.
- Add policies as needed for public access (orders), and restricted access (admin).

## 6. (Optional) Storage for Images
- Use Supabase Storage for menu images.

## 7. Connect from Node.js
- Install the Supabase JS client:
  ```bash
  npm install @supabase/supabase-js
  ```
- Use your Project URL and API key to connect.

## 8. Resources
- [Supabase Docs](https://supabase.com/docs)
- [Table Editor Guide](https://supabase.com/docs/guides/database/tables)

## 9. Row Level Security (RLS) Policies

By default, enabling RLS on a table blocks all access until you add policies. Here are recommended policies for your tables:

### 9.1. Enable RLS
Enable RLS for each table:
```sql
ALTER TABLE menu ENABLE ROW LEVEL SECURITY;
ALTER TABLE services ENABLE ROW LEVEL SECURITY;
ALTER TABLE trending ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE admin_users ENABLE ROW LEVEL SECURITY;
```

### 9.2. Example Policies

#### a) Menu, Services, Trending (Public Read)
Allow anyone to read (select) these tables:
```sql
-- Menu
CREATE POLICY "Public read menu" ON menu
  FOR SELECT USING (true);

-- Services
CREATE POLICY "Public read services" ON services
  FOR SELECT USING (true);

-- Trending
CREATE POLICY "Public read trending" ON trending
  FOR SELECT USING (true);
```

#### b) Orders (Public Insert, User Can Read Own)
Allow anyone to insert orders (for placing orders):
```sql
CREATE POLICY "Public insert orders" ON orders
  FOR INSERT USING (true);
```
Allow anyone to read orders (for testing; restrict in production):
```sql
CREATE POLICY "Public read orders" ON orders
  FOR SELECT USING (true);
```
*For production, you may want to restrict SELECT to only the user who placed the order.*

#### c) Admin Users (Admins Only)
Allow only service role (your backend) to select/insert/update/delete admin users:
```sql
CREATE POLICY "Service role full access admin_users" ON admin_users
  FOR ALL USING (auth.role() = 'service_role');
```

### 9.3. How to Apply
1. Go to the **SQL Editor** in Supabase.
2. Paste the above RLS SQL code and run it after creating your tables.
3. Adjust policies as needed for your app's security.

---
**Note:**
- For production, always review and restrict policies to protect sensitive data.
- You can use Supabase Auth for user-specific access if needed.

You are now ready to use Supabase as your backend database! 